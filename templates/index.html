<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flush Analytics</title>
</head>
<body>
  <h1>Some Data Analysis on Flushes</h1>
  <h2></h2>
  <p>This app supports the following operations:</p>
  <img src="http://images.mentalfloss.com/sites/default/files/styles/mf_image_3x2/public/toiletseat.png?itok=mcwKm0nF&resize=1100x740">
  <menu>
    <li><a href="/graphs"><button type="button">click to see graphs</button></a></li>
    <li><a href="/map"><button type="button">click to see toilets in buildings</button></a></li>
    <li><a href="/live"><button type="button">click for nothing yet</button></a></li>
    <li><a href="/simulator"><button type="button">click to try flushing yourself!</button></a></li>
    </menu>
  <!-- Latest compiled and minified plotly.js JavaScript -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <div id="tester" style="width:800px;height:500px;"></div>
  <script>
      var vals = {{ values|tojson }};

      var x_dups = vals.map(a => {
        d = new Date(a.time);
        m = d.getMinutes();
        d.setMinutes(m % 5 >= 3 ? m + (5 - (m%5)) : m - (m % 5));
        return d;
      });

      var x_axis1 = [];
      var y_axis1 = [];
      var last_x = new Date(2000, 01, 01);

      var i;
      for (i=0; i<x_dups.length; i++) {
        x = x_dups[i];
        if (x <= last_x) {
          if (x < last_x) {
            break;
          }
          y_axis1[y_axis1.length - 1] += 1;
        } else {
          y_axis1.push(1);
          x_axis1.push(x);
        }
        last_x = x;
      }

      var trace1 = {
        x: x_axis1,
        y: y_axis1,
        type: 'scatter',
        mode: 'line',
        line: {
          shape: 'spline',
          color: 'royalblue'
        },
        name: "men's"
      };

      var x_axis2 = [];
      var y_axis2 = [];
      var last_x = new Date(2000, 01, 01);
      var j;
      for (j=i; j<x_dups.length; j++) {
        x = x_dups[j];
        if (x <= last_x) {
          y_axis2[y_axis2.length - 1] += 1;
        } else {
          y_axis2.push(1);
          x_axis2.push(x);
        }
        last_x = x;
      }

      var trace2 = {
        x: x_axis2,
        y: y_axis2,
        type: 'scatter',
        mode: 'line',
        line: {
          shape: 'spline',
          color: 'hotpink'
        },
        name: "women's"
      };
      
      var data = [trace2, trace1];
      
      var layout = {
        title: 'Flushes over time',
        showlegend: true,
        yaxis: {
          range: [0, 8],
          type: 'linear'
        }
      };
      
      Plotly.newPlot('tester', data, layout);
  </script>
</body>
</html> 
